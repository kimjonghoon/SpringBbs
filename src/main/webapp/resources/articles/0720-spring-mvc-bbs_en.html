<article>

<h1>Bulletin Board on Spring MVC</h1>

<p>
This article covers modifying the Model 2 project to Spring MVC project.<br />
You need the final source of <a href="/spring/building-java-projects-with-maven">'Building Spring MVC with maven'</a> and the final source of the Model 2 bulletin board of the <a href="/jsp-pjt">JSP Porject</a> chapter.<br />
If Git be installed on your system, you can download the Model 2 final source with the following command:
</p>

<pre>
git clone https://github.com/kimjonghoon/model2
</pre>

<h2>Database design</h2>

<p>
See <a href="/jsp-pjt/database-design">Database design</a>.
</p>

<h2>Stylesheets and Images</h2>

<p>
Copy the /css and /images folders from C:/www/model2/WebContent on the Model 2 bulletin board and paste them into the Document Base, C:/www/spring-bbs/src/main/webapp directory.
</p>

<h2>JSPs</h2>

<p>
Create the /views folder under C:/www/spring-bbs/src/main/webapp/WEB-INF.<br />
Copy the index.jsp, error.jsp, /bbs, /inc, /java, /users folders from the Document Base of Model 2 board and paste them into the /views folder.
</p>

<p>
The reason for putting the JSP in the /WEB-INF subdirectory is to prevent the web browser from directly accessing JSPs.<br />
Spring MVC recommends that all requests be passed to the controller through the dispatcher servlet.
</p>

<h2>Java sources</h2>

<p>
Copy all the Java source folders from C:/www/model2/src/net/java_school on the Model 2 bulletin board and paste them into C:/www/spring-bbs/src/main/java.
</p>

<h2>Modify JSP</h2>

<p>
As recommended by Spring MVC, set the following in web.xml so that the dispatcher servlet will handle all requests:
</p>

<pre class="prettyprint">
&lt;servlet-mapping&gt;
	&lt;servlet-name&gt;spring-bbs&lt;/servlet-name&gt;
	&lt;url-pattern&gt;/&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</pre>

<h3>Change the request string within JSPs</h3>

<p>
The Model 2 board controller was only responsible for requests ending in .do.<br />
Therefore, you must modify all request strings ending in .do in the JSP of the Model 2 bulletin board.<br />
Remove .do from request strings ending in .do in any JSP.<br />
For example, modify ../users/login.do in header.jsp to ../users/login.
</p>

<h3>Change date format in list.jsp and view.jsp</h3>

<p>
The date formats in list.jsp and view.jsp will be different.<br />
Add the following tag libraries to both files:
</p>

<pre class="prettyprint">
&lt;%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %&gt;
</pre>

<p>
In list.jsp, find the part that displays the date and modify it as follows.
</p>

<pre class="prettyprint">
&lt;fmt:formatDate pattern="yyyy.MM.dd" value="${article.regdate }" /&gt;
</pre>

<p>
In view.jsp, find the part that displays the date and modify it as follows.
</p>

<pre class="prettyprint">
&lt;fmt:formatDate pattern="yyyy.MM.dd HH:mm:ss" value="${regdate }" /&gt;
&lt;fmt:formatDate pattern="yyyy.MM.dd" value="${article.regdate }" /&gt;
</pre>

<h3>Create download.jsp</h3>

<p>
The view.jsp on the Model 2 bulletin board simply links the attachment.<br />
On the Spring MVC bulletin board, the download.jsp be used to download the attachment.<br />
With download.jsp, you can download attachments even if they are in a location that your web browser can not access.
</p>

<h6 class="src">/WEB-INF/views/inc/download.jsp</h6>
<pre class="prettyprint">
&lt;%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%&gt;	  
&lt;%@ page import="java.io.File" %&gt;
&lt;%@ page import="java.net.URLEncoder" %&gt;
&lt;%@ page import="java.io.OutputStream" %&gt;
&lt;%@ page import="java.io.FileInputStream" %&gt;
&lt;%@ page import="java.io.IOException" %&gt;
&lt;%@ page import="org.springframework.util.FileCopyUtils" %&gt;
&lt;%@ page import="net.java_school.commons.WebContants" %&gt;
&lt;%
//request.setCharacterEncoding("UTF-8");//This is done by a filter.
String filename = request.getParameter("filename");

File file = new File(<strong>WebContants.UPLOAD_PATH</strong> + filename);

String filetype = filename.substring(filename.indexOf(".") + 1, filename.length());

if (filetype.trim().equalsIgnoreCase("txt")) {
  response.setContentType("text/plain");
} else {
  response.setContentType("application/octet-stream");
}

response.setContentLength((int) file.length());

boolean ie = request.getHeader("User-Agent").indexOf("MSIE") != -1;
if (ie) {
  filename = URLEncoder.encode(filename, "UTF-8").replaceAll("\\+", " ");
} else {
  filename = new String(filename.getBytes("UTF-8"), "8859_1");
}

response.setHeader("Content-Disposition", "attachment; filename=\"" + filename + "\"");

OutputStream outputStream = response.getOutputStream();
FileInputStream fis = null;

try {
  fis = new FileInputStream(file);
  FileCopyUtils.copy(fis, outputStream);
} finally {
  if (fis != null) {
    try {
      fis.close();
    } catch (IOException e) {}
  }
}

out.flush();
%&gt;
</pre>

<p>
In the above, WebContants.UPLOAD_PATH is the directory where the attachment is located. Add UPLOAD_PATH to WebContants.java.
</p>

<h6 class="src">WebContants.java</h6>
<pre class="prettyprint">package net.java_school.commons;

public class WebContants {
  //Session key
  public final static String USER_KEY = "user";
  //Error Message
  public final static String NOT_LOGIN = "Not Login";
  public final static String AUTHENTICATION_FAILED = "Authentication Failed";
  //Line Separator
  public final static String LINE_SEPARATOR = System.getProperty("line.separator");
  //Upload Path
  <strong>public final static String UPLOAD_PATH = "C:/www/spring-bbs/upload/";</strong>
}
</pre>

<p>
C:/www/spring-bbs/upload/ is a directory that the web browser can not access.<br />
Therefore, you can not download attachments as links.<br />
Note that the attachment download code in view.jsp must be changed.
</p>

<h2>Logging</h2>

<p>
Create the following file in C:/www/spring-bbs/src/main/resources.<br />
If the /resources folder does not exist, create it and run <strong>'Maven' - 'Update Project...'</strong> to synchronize.
</p>

<h6 class="src">commons-logging.properties</h6>
<pre class="prettyprint">
org.apache.commons.logging.Log = org.apache.commons.logging.impl.Log4JLogger
</pre>

<h6 class="src">log4j2.xml</h6>
<pre class="prettyprint">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration&gt;
	&lt;Appenders&gt;
		&lt;File name="A1" fileName="A1.log" append="true"&gt;
			&lt;PatternLayout pattern="%t %-5p %c{2} - %m%n" /&gt;
		&lt;/File&gt;
		&lt;Console name="STDOUT" target="SYSTEM_OUT"&gt;
			&lt;PatternLayout pattern="%d %-5p [%t] %C{2} (%F:%L) - %m%n" /&gt;
		&lt;/Console&gt;
	&lt;/Appenders&gt;
	&lt;Loggers&gt;
		&lt;Logger name="net.java_school" level="debug"&gt;
			&lt;AppenderRef ref="A1" /&gt;
		&lt;/Logger&gt;
		&lt;Root level="debug"&gt;
			&lt;AppenderRef ref="STDOUT" /&gt;
		&lt;/Root&gt;
	&lt;/Loggers&gt;
&lt;/Configuration&gt;
</pre>


<h2>Membership</h2>

<p>
Database-related code will be modified to use the MyBatis-Spring.
</p>

<p>
Change UserService.java to interface.
</p>

<h6 class="src">UserService.java</h6>

<pre class="prettyprint">package net.java_school.user;

public interface UserService {
    
  public void addUser(User user);

  public User login(String email, String passwd);

  public int editAccount(User user);

  public int changePasswd(String currentPasswd, String newPasswd, String email);

  public void bye(User user);

  public User getUser(String email);
    
}
</pre>

<p>
Create UserMapper.java in the net.java_school.mybatis package.
</p>

<h6 class="src">UserMapper.java</h6>
<pre class="prettyprint">package net.java_school.mybatis;

import org.apache.ibatis.annotations.Param;

import net.java_school.user.User;

public interface UserMapper {
    
  public void insert(User user);

  public User login(
    @Param("email") String email, 
    @Param("passwd") String passwd);

  public int update(User user);

  public int <strong>updatePasswd</strong>(
    @Param("currentPasswd") String currentPasswd, 
    @Param("newPasswd") String newPasswd, 
    @Param("email") String email);

  public int delete(User user);

  public User selectOne(String email);
    
}
</pre>

<p>
Create UserServiceImpl.java in the net.java_school.user package.
</p>

<h6 class="src">UserServiceImpl.java</h6>
<pre class="prettyprint">
package net.java_school.user;

import net.java_school.mybatis.UserMapper;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserServiceImpl implements UserService {
    
  @Autowired
  private UserMapper userMapper;
    
  public void addUser(User user) {
    userMapper.insert(user);
  }

  public User login(String email, String passwd) {
    return userMapper.login(email, passwd);
  }

  public int editAccount(User user) {
    return userMapper.update(user);
  }

  public int changePasswd(String currentPasswd, String newPasswd, String email) {
    return userMapper.updatePasswd(currentPasswd, newPasswd, email);
  }

  public void bye(User user) {
    userMapper.delete(user);
  }

  public User getUser(String email) {
    return userMapper.selectOne(email);
  }
    
}
</pre>

<p>
In the project explorer view, create the net.java_school.mybatis package in src/main/resources, and create the MyBatis related configuration file Congifuration.xml in this package.<br />
This file sets the alias of the type and the location of the mapper files.<br />
The configuration file to be created in the classpath in the Maven project must be created in src/main/resources.<br />
If you create a configuration file in the source directory in the Maven project, it will not be copied to the classpath.
</p>

<h6 class="src">Configuration.xml</h6>
<pre class="prettyprint">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE configuration 
    PUBLIC "-//mybatis.org//DTD Config 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;

&lt;configuration&gt; 

  &lt;settings&gt;
    &lt;setting name="logImpl" value="LOG4J2"/&gt;
  &lt;/settings&gt;
  	    
  &lt;typeAliases&gt;
    &lt;typeAlias type="net.java_school.board.AttachFile" alias="AttachFile" /&gt;
    &lt;typeAlias type="net.java_school.board.Comment" alias="Comment" /&gt;
    &lt;typeAlias type="net.java_school.board.Board" alias="Board" /&gt;
    &lt;typeAlias type="net.java_school.board.Article" alias="Article" /&gt;
    &lt;typeAlias type="net.java_school.user.User" alias="User" /&gt;
  &lt;/typeAliases&gt;

  &lt;mappers&gt;
    &lt;mapper resource="net/java_school/mybatis/BoardMapper.xml" /&gt;
    <strong>&lt;mapper resource="net/java_school/mybatis/UserMapper.xml" /&gt;</strong>
  &lt;/mappers&gt;

&lt;/configuration&gt;
</pre>

<p>
Create a UserMapper.xml file in the same location as Configuration.xml.<br />
In the mapper file, the id must match the method name in UserMapper.java.
</p>

<h6 class="src">UserMapper.xml</h6>
<pre class="prettyprint">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;

&lt;mapper namespace="net.java_school.mybatis.UserMapper"&gt;
    
  &lt;insert id="insert" parameterType="User"&gt;
    INSERT INTO member VALUES (#{email}, #{passwd}, #{name}, #{mobile})
  &lt;/insert&gt;

  &lt;select id="login" resultType="User"&gt;
    SELECT email, passwd, name, mobile FROM member 
    WHERE email = #{email} AND passwd = #{passwd}
  &lt;/select&gt;

  &lt;update id="update" parameterType="User"&gt;
    UPDATE member SET name = #{name}, mobile = #{mobile} 
    WHERE email = #{email} AND passwd = #{passwd}
  &lt;/update&gt;

  &lt;update id="updatePasswd"&gt;
    UPDATE member SET passwd = #{newPasswd} 
    WHERE passwd = #{currentPasswd} AND email = #{email}
  &lt;/update&gt;

  &lt;delete id="delete"&gt;
    DELETE FROM member 
    WHERE email = #{email}
  &lt;/delete&gt;

  &lt;select id="selectOne" parameterType="string" resultType="User"&gt;
    SELECT email, passwd, name, mobile 
    FROM member
    WHERE email = #{email}
  &lt;/select&gt;
    
&lt;/mapper&gt;
</pre>

<p>
Create UsersController.java in the net.java_school.controller package.<br />
If you want this controller to handle all requests involving "/users", 
add the @Controller annotation to the class declaration and add the @RequestMapping ("users") annotation right below the @Controller annotation.
</p>

<h6 class="src">UsersController.java</h6>
<pre class="prettyprint">package net.java_school.controller;

import java.net.URLEncoder;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import net.java_school.commons.WebContants;
import net.java_school.exception.AuthenticationException;
import net.java_school.user.User;
import net.java_school.user.UserService;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
<strong>
@Controller
@RequestMapping("users")</strong>
public class UsersController {
    
  <strong>@Autowired</strong>
  private UserService userService;

  <strong>@RequestMapping(value="signUp", method=RequestMethod.GET)</strong>
  public String signUp() {
    return "users/signUp";
  }

  @RequestMapping(value="signUp", method=RequestMethod.POST)
  public String signUp(User user) {
    userService.addUser(user);
    return "<strong>redirect:/users/welcome</strong>";
  }

  @RequestMapping(value="<strong>welcome</strong>", method=RequestMethod.GET)
  public String welcome() {
    return "users/welcome";
  }

  @RequestMapping(value="login", method=RequestMethod.GET)
  public String login() {
    return "users/login";
  }
    
  @RequestMapping(value="login", method=RequestMethod.POST)
  public String login(String email, String passwd, String url, HttpSession session) {
    User user = userService.login(email, passwd);
        
    if (user == null) {
      return "redirect:/users/login?url=" + url + "&amp;msg=Login-Failed";
    } else {
      session.setAttribute(WebContants.USER_KEY, user);
      if (!url.equals("")) {
        return "redirect:" + url;
      }
      
      return "redirect:/";
    }
        
  }
        
  @RequestMapping(value="editAccount", method=RequestMethod.GET)
  public String editAccount(HttpServletRequest req, HttpSession session) throws Exception {
    User user = (User) session.getAttribute(WebContants.USER_KEY);

    if (user == null) {
      String url = req.getServletPath();
      String query = req.getQueryString();
      if (query != null) url += "?" + query;
      url = URLEncoder.encode(url, "UTF-8");
      
      return "redirect:/users/login?url=" + url;
    }

    return "users/editAccount";
  }
    
  @RequestMapping(value="editAccount", method=RequestMethod.POST)
  public String editAccount(User user, HttpSession session) {
    User loginUser = (User) session.getAttribute(WebContants.USER_KEY);
    if (loginUser == null) {
      throw new AuthenticationException(WebContants.NOT_LOGIN);
    }

    user.setEmail(loginUser.getEmail());
        
    int check = userService.editAccount(user);
    if (check &lt; 1) {
      throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
    }
    
    session.setAttribute(WebContants.USER_KEY, user);

    return "users/changePasswd";
        
  }
    
  @RequestMapping(value="changePasswd", method=RequestMethod.GET)
  public String changePasswd(HttpServletRequest req, HttpSession session) throws Exception {
    User user = (User) session.getAttribute(WebContants.USER_KEY);
        
    if (user == null) {
      String url = req.getServletPath();
      String query = req.getQueryString();
      if (query != null) url += "?" + query;
      url = URLEncoder.encode(url, "UTF-8");
      return "redirect:/users/login?url=" + url;     
    }
        
    return "users/changePasswd";
  }
    
  @RequestMapping(value="changePasswd", method=RequestMethod.POST)
  public String changePasswd(String currentPasswd, String newPasswd, HttpSession session) {
    String email = ((User)session.getAttribute(WebContants.USER_KEY)).getEmail();
        
    int check = userService.changePasswd(currentPasswd, newPasswd, email);
    if (check &lt; 1) {
        throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
    } 
    
    return "redirect:/users/changePasswd_confirm";
        
  }
    
  @RequestMapping(value="changePasswd_confirm", method=RequestMethod.GET)
  public String changePasswd_confirm() {
    return "users/changePasswd_confirm";
  }
    
  @RequestMapping(value="bye", method=RequestMethod.GET)
  public String bye(HttpServletRequest req, HttpSession session) throws Exception {
    User user = (User)session.getAttribute(WebContants.USER_KEY);
        
    if (user == null) {
      String url = req.getServletPath();
      String query = req.getQueryString();
      if (query != null) url += "?" + query;
      url = URLEncoder.encode(url, "UTF-8");
      
      return "redirect:/users/login?url=" + url;     
    }
        
    return "users/bye";
  }

  @RequestMapping(value="bye", method=RequestMethod.POST)
  public String bye(String email, String passwd, HttpSession session) {
    User user = (User)session.getAttribute(WebContants.USER_KEY);

    if (user == null || !user.getEmail().equals(email)) {
      throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
    }
    
    user = userService.login(email, passwd);
    userService.bye(user);
    session.removeAttribute(WebContants.USER_KEY);
    
    return "redirect:/users/bye_confirm";
        
  }
  
  @RequestMapping(value="bye_confirm", method=RequestMethod.GET)
  public String bye_confirm() {
  
    return "users/bye_confirm";	  
  } 
    
  @RequestMapping(value="logout", method=RequestMethod.GET)
  public String logout(HttpSession session) {
    session.removeAttribute(WebContants.USER_KEY);

    return "redirect:/";

  }

}
</pre>

<p>
The @RequestMapping(value="signUp", method=RequestMethod.GET) annotation above the method declaration allows the method to handle the "/users/signUp" request of the GET method.<br />
(The "/users" part of "/users/signUp" is due to the @RequestMapping("users") annotation added above the UsersController class declaration)
</p>

<p>
@RequestMapping(value="/signUp", method=RequestMethod.POST) above the method declaration allows the method to handle the "/users/signUp" request of the POST method.<br />
Even if the request string is the same, it is possible to handle each request separately by HTTP method.<br />
The method invoked on the /users/signUp request of the POST method get your web browser redirects the request to welcome.jsp after completing membership.<br />
If this method changes the screen using forwarding after membership, the user can try to subscribe with the same information using the F5 button.<br />
Redirect does not have this problem.<br />
If you have chosen a redirect, You need to write a method with the following annotation on the controller.
</p>
<pre class="prettyprint">@RequestMapping(value="welcome", method="RequestMethod.GET")</pre>

<p>
HomeController is the controller responsible for homepage request.
</p>

<h6 class="src">HomeController.java</h6>
<pre class="prettyprint">package net.java_school.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
@RequestMapping("/")
public class HomeController {
    @RequestMapping(method=RequestMethod.GET)
    public String index() {
        return "index";
    }
}
</pre>

<p>
The JavaController is the controller that handles all requests that contain "/java".
</p>

<h6 class="src">JavaController.java</h6>
<pre class="prettyprint">package net.java_school.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
@RequestMapping("java")
public class JavaController {

    @RequestMapping(method=RequestMethod.GET)
    public String index() {
        return "java/index";
    }
    
    @RequestMapping(value="jdk-install", method=RequestMethod.GET)
    public String basic() {
        return "java/jdk-install";
    }

}
</pre>

<p>
The JavascriptController is the controller that handles all requests that contain "/javascript".
</p>

<h6 class="src">JavascriptController.java</h6>
<pre class="prettyprint">package net.java_school.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
@RequestMapping("javascript")
public class JavascriptController {

    @RequestMapping(method=RequestMethod.GET)
    public String index() {
        return "javascript/index";
    }
    
}
</pre>

<p>
Since spring-bbs is the name of DispatcherServlet in web.xml, create sprng-bbs-servlet.xml file in /WEB-INF folder.
</p>

<h6 class="src">spring-bbs-servlet.xml</h6>
<pre class="prettyprint">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xmlns:mvc="http://www.springframework.org/schema/mvc"
  xmlns:p="http://www.springframework.org/schema/p"
  xmlns:mybatis="http://mybatis.org/schema/mybatis-spring"
  xsi:schemaLocation="http://www.springframework.org/schema/beans 
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/context
    http://www.springframework.org/schema/context/spring-context.xsd
    http://www.springframework.org/schema/mvc
    http://www.springframework.org/schema/mvc/spring-mvc.xsd
    http://mybatis.org/schema/mybatis-spring 
    http://mybatis.org/schema/mybatis-spring.xsd"&gt;
            
  &lt;!-- The following tells Dispatcher servlet the location of the static resource.  --&gt;
  &lt;mvc:resources location="/images/" mapping="/images/**" /&gt;
  &lt;mvc:resources location="/css/" mapping="/css/**" /&gt;
        
  &lt;mvc:annotation-driven /&gt;
    
  &lt;context:component-scan
    base-package="net.java_school.controller,
    	net.java_school.board, 
    	net.java_school.user, " /&gt;

  &lt;mybatis:scan base-package="net.java_school.mybatis" /&gt;

  &lt;bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close"&gt;
    &lt;property name="driverClassName" value="oracle.jdbc.driver.OracleDriver"/&gt;
    &lt;property name="url" value="jdbc:oracle:thin:@127.0.0.1:1521:XE"/&gt;
    &lt;property name="username" value="java"/&gt;
    &lt;property name="password" value="school"/&gt;
    &lt;property name="maxActive" value="100"/&gt;
    &lt;property name="maxWait" value="1000"/&gt;
    &lt;property name="poolPreparedStatements" value="true"/&gt;
    &lt;property name="defaultAutoCommit" value="true"/&gt;
    &lt;property name="validationQuery" value=" SELECT 1 FROM DUAL" /&gt;
  &lt;/bean&gt;
    
  &lt;bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean"&gt;
    &lt;property name="dataSource" ref="dataSource" /&gt;
    &lt;property name="configLocation" value="classpath:net/java_school/mybatis/Configuration.xml" /&gt;
  &lt;/bean&gt;

  &lt;bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver"&gt;
    &lt;property name="maxUploadSize" value="2097152" /&gt;
  &lt;/bean&gt;
    
  &lt;!-- ViewResolver --&gt;
  &lt;bean id="internalResourceViewResolver" 
      class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;
    &lt;property name="viewClass"&gt;
      &lt;value&gt;org.springframework.web.servlet.view.JstlView&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name="prefix"&gt;
      &lt;value&gt;/WEB-INF/views/&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name="suffix"&gt;
      &lt;value&gt;.jsp&lt;/value&gt;
    &lt;/property&gt;
  &lt;/bean&gt;
  
  &lt;bean class="org.springframework.web.servlet.handler.SimpleMappingExceptionResolver"&gt;
    &lt;property name="defaultErrorView" value="error" /&gt;
    &lt;property name="exceptionMappings"&gt;
      &lt;props&gt;
        &lt;prop key="net.java_school.exception.AuthenticationException"&gt;
          <strong>403-error</strong>
        &lt;/prop&gt;
      &lt;/props&gt;
    &lt;/property&gt;
  &lt;/bean&gt;
&lt;/beans&gt;
</pre>

<h3>spring-bbs-servlet.xml</h3>

<p>
The following tells Dispatcher servlet the location of the static resource.
</p>

<pre class="prettyprint">
<strong>&lt;mvc:resources location=".." /&gt;</strong>
</pre>

<p>
The next setting will automatically scan the bean and register it in the container.<br />
The scanned bean does not need to be registered in the Spring configuration file.<br />
In order for a bean to auto-scan, it must belong to the base-package package and have an annotation indicating that it is a component above the class declaration.<br />
Classes with @Controller and @Repository annotations above the class declaration are treated as annotation names.<br />
@Repository is used for DAO class.<br />
The @Component and @Service annotations above the class declaration only indicate that the class is only auto-scanned, and nothing else is special.
</p>

<pre class="prettyprint">
<strong>&lt;context:component-scan base-package=".." /&gt;</strong>
</pre>

<p>
Spring applications that run on an annotation base require the following settings:
</p>

<pre class="prettyprint">
<strong>&lt;mvc:annotation-driven /&gt;</strong>
</pre>

<p>
The following settings scan mybatis-spring beans and register them in the container.
</p>

<pre class="prettyprint">
<strong>&lt;mybatis:scan base-package=".." /&gt;</strong>
</pre>

<p>
Using the above configuration, you can omit the following settings from the Spring configuration file.
</p>

<pre class="prettyprint">
&lt;bean id="boardMapper" class="org.mybatis.spring.mapper.MapperFactoryBean"&gt;
  &lt;property name="mapperInterface" value="net.java_school.mybatis.BoardMapper" /&gt;
  &lt;property name="sqlSessionFactory" ref="sqlSessionFactory" /&gt;
&lt;/bean&gt;
</pre>

<p>
The dataSource definition is always needed whether you use Spring JDBC or MyBatis.
</p>

<pre class="prettyprint">
<strong>&lt;bean id="dataSource" ..&gt;</strong>
</pre>

<p>
All MyBatis applications must use instances of the SqlSessionFactory interface type.<br />
MyBatis Spring uses the SqlSessionFactoryBean.
</p>

<pre class="prettyprint">
<strong>&lt;bean id="sqlSessionFactory" ..&gt;</strong>
</pre>

<p>
The following are settings for uploading files.<br />
When uploading a file, a wrapper for the HttpServletRequest is passed to the controller.<br />
The method that handles the uploaded file must cast the wrapper to the MultiPartHttpServletRequest interface to handle the multipart file passed to the server.
</p>

<pre class="prettyprint">
<strong>&lt;bean id="multipartResolver" ..&gt;</strong>
</pre>


<p>
The following is a setting for how to interpret the view from the string returned by the controller.
</p>

<pre class="prettyprint">
&lt;bean class="org.springframework.web.servlet.handler.SimpleMappingExceptionResolver"&gt;
</pre>

<p>
The following are the settings for Spring MVC exception handling.<br />
Spring MVC has several exception handling methods.<br />
Among them, it is easiest to use SimpleMappingExceptionResolver.<br />
<br />
If an AuthenticationException exception is thrown, the 403-error view is set to be selected.<br />
The 403-error is interpreted as /WEB-INF/views/403-error.jsp by the view resolver.<br />
<br />
Create a 403-error.jsp file that says "Access Denied".<br />
For reference, you do not need to define a handler for the / 403-error to the controller.
</p>

<pre class="prettyprint">
&lt;prop key="net.java_school.exception.AuthenticationException"&gt;
  403-error
&lt;/prop&gt;
</pre>

<p>
If any other exception occurs, the following setting handles the error.
</p>

<pre class="prettyprint">
&lt;property name="defaultErrorView" value="error" /&gt;
</pre>

<h2>Board</h2>

<p>
Create the BoardMapper.xml file in the same location as the UserMapper.xml, as configured in Configuration.xml.
</p>

<h6 class="src">BoardMapper.xml</h6>
<pre class="prettyprint">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;

&lt;!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;

&lt;mapper namespace="net.java_school.mybatis.BoardMapper"&gt;

    &lt;select id="selectListOfArticles" parameterType="hashmap" resultType="Article"&gt;
    SELECT articleno, title, regdate, hit, name, attachfileNum, commentNum 
    FROM (
        SELECT rownum r,a.* 
            FROM (
                SELECT 
                    a.articleno, a.title, a.regdate, a.hit, m.name,
                    COUNT(DISTINCT(f.attachfileno)) attachfileNum, 
                    COUNT(DISTINCT(c.commentno)) commentNum
                FROM 
                    article a, attachfile f, comments c, member m
                WHERE
                    a.articleno = f.articleno(+)
                    AND a.articleno = c.articleno(+)
                    AND a.email = m.email(+)
                    AND a.boardcd = #{boardCd}
                    &lt;if test="searchWord != null and searchWord != ''"&gt;
                    AND (title LIKE '%${searchWord}%' OR DBMS_LOB.INSTR(content, #{searchWord}) &gt; 0)
                    &lt;/if&gt;
                GROUP BY a.articleno, title, a.regdate, hit, m.name
                ORDER BY articleno DESC
                ) a
        )
    WHERE r BETWEEN #{start} AND #{end}
    &lt;/select&gt;

    &lt;select id="selectCountOfArticles" parameterType="hashmap" resultType="int"&gt;
        SELECT count(*) FROM article WHERE boardcd = #{boardCd}
            &lt;if test="searchWord != null and searchWord != ''"&gt;
            AND (title LIKE '%${searchWord}%' OR DBMS_LOB.INSTR(content, #{searchWord}) &gt; 0)
            &lt;/if&gt;
    &lt;/select&gt;

    &lt;insert id="insert" parameterType="Article" useGeneratedKeys="true"&gt;
        &lt;selectKey keyProperty="articleNo" resultType="int" order="BEFORE"&gt;
            SELECT seq_article.nextval FROM dual
        &lt;/selectKey&gt;
        INSERT INTO article (articleNo, boardCd, title, content, email, hit, regdate)
        VALUES
        (#{articleNo}, #{boardCd}, #{title}, #{content}, #{email}, 0, sysdate)
    &lt;/insert&gt;

    &lt;insert id="insertAttachFile" parameterType="AttachFile"&gt;
        INSERT INTO attachfile (attachfileno, filename, filetype, filesize, articleno, email)
        VALUES
        (seq_attachfile.nextval, #{filename}, #{filetype}, #{filesize}, #{articleNo}, #{email})
    &lt;/insert&gt;
    
    &lt;update id="update" parameterType="Article"&gt;
        UPDATE article 
        SET title = #{title}, content = #{content} 
        WHERE articleno = #{articleNo}
    &lt;/update&gt;
    
    &lt;delete id="delete" parameterType="int"&gt;
        DELETE FROM article WHERE articleno = #{articleNo}
    &lt;/delete&gt;
    
    &lt;update id="updateHitPlusOne" parameterType="int"&gt;
        UPDATE article SET hit = hit + 1 WHERE articleno = #{articleNo}
    &lt;/update&gt;
    
    &lt;select id="selectOne" parameterType="int" resultType="Article"&gt;
        SELECT 
            articleno, 
            title, 
            content, 
            a.email, 
            NVL(name, 'Anonymous') name, 
            hit, 
            regdate
        FROM article a, member m
        WHERE a.email = m.email(+) AND articleno = #{articleNo}
    &lt;/select&gt;
    
    &lt;select id="selectNextOne" parameterType="hashmap" resultType="Article"&gt;
        SELECT articleno, title
        FROM
            (SELECT rownum r,a.*
            FROM
                (SELECT articleno, title 
                FROM article 
                WHERE 
                    boardCd = #{boardCd} 
                    AND articleno &gt; #{articleNo}
                &lt;if test="searchWord != null and searchWord != ''"&gt;
                    AND (title LIKE '%${searchWord}%' OR DBMS_LOB.INSTR(content, #{searchWord}) &gt; 0)
                &lt;/if&gt;
                ORDER BY articleno) 
            a)
        WHERE r = 1
    &lt;/select&gt;
    
    &lt;select id="selectPrevOne" parameterType="hashmap" resultType="Article"&gt;
        SELECT articleno, title
        FROM
            (SELECT rownum r,a.*
            FROM
                (SELECT articleno, title 
                FROM article 
                WHERE 
                    boardCd = #{boardCd} 
                    AND articleno &lt; #{articleNo}
                &lt;if test="searchWord != null and searchWord != ''"&gt;
                    AND (title LIKE '%${searchWord}%' OR DBMS_LOB.INSTR(content, #{searchWord}) &gt; 0)
                &lt;/if&gt; 
                ORDER BY articleno DESC)
            a)
        WHERE r = 1
    &lt;/select&gt;
    
    &lt;select id="selectListOfAttachFiles" parameterType="int" resultType="AttachFile"&gt;
        SELECT 
            attachfileno, 
            filename, 
            filetype, 
            filesize, 
            articleno, 
            email
        FROM attachfile 
        WHERE articleno = #{articleNo} 
        ORDER BY attachfileno
    &lt;/select&gt;
    
    &lt;delete id="deleteFile" parameterType="int"&gt;
        DELETE FROM attachfile WHERE attachfileno = #{attachFileNo}
    &lt;/delete&gt;
    
    &lt;select id="selectOneBoard" parameterType="string" resultType="string"&gt;
        SELECT * FROM board WHERE boardcd = #{boardCd}
    &lt;/select&gt;
    
    &lt;insert id="insertComment" parameterType="Comment"&gt;
        INSERT INTO comments (commentno, articleno, email, memo, regdate)
        VALUES (seq_comments.nextval, #{articleNo}, #{email}, #{memo}, sysdate)
    &lt;/insert&gt;
    
    &lt;update id="updateComment" parameterType="Comment"&gt;
        UPDATE comments SET memo = #{memo} WHERE commentno = #{commentNo}
    &lt;/update&gt;
    
    &lt;delete id="deleteComment" parameterType="int"&gt;
        DELETE FROM comments WHERE commentno = #{commentNo}
    &lt;/delete&gt;

    &lt;select id="selectListOfComments" parameterType="int" resultType="Comment"&gt;
        SELECT 
            commentno, 
            articleno, 
            c.email, 
            NVL(name,'Anonymous') name, 
            memo, 
            regdate
        FROM comments c, member m
        WHERE 
            c.email = m.email(+)
            AND articleno = #{articleNo}
        ORDER BY commentno DESC
    &lt;/select&gt;

    &lt;select id="selectOneAttachFile" parameterType="int" resultType="AttachFile"&gt;
        SELECT 
            attachfileno, 
            filename, 
            filetype, 
            filesize, 
            articleno, 
            email
        FROM attachfile
        WHERE attachfileno = #{attachFileNo}
    &lt;/select&gt;
    
    &lt;select id="selectOneComment" parameterType="int" resultType="Comment"&gt;
        SELECT 
            commentno,
            articleno,
            email,
            memo,
            regdate 
        FROM comments 
        WHERE commentno = #{commentNo}
    &lt;/select&gt;

&lt;/mapper&gt;
</pre>

<h3>How to make MyBatis return a unique number after an insert</h3>

<p>
Add useGeneratedKeys="true".<br />
For databases that do not have auto-increment columns lide Oracle, add the selectKey subelement as follows:
</p>

<pre class="prettyprint">
&lt;insert id="insert" parameterType="Article" <strong>useGeneratedKeys="true"</strong>&gt;
    <strong>&lt;selectKey keyProperty="articleNo" resultType="int" order="BEFORE"&gt;
        SELECT seq_article.nextval FROM dual
    &lt;/selectKey&gt;</strong>
    INSERT INTO article (articleNo, boardCd, title, content, email, hit, regdate)
    VALUES
    (#{articleNo}, #{boardCd}, #{title}, #{content}, #{email}, 0, sysdate)
&lt;/insert&gt;
</pre>

<p>
Create BoardMapper.java as shown below.
</p>

<h6 class="src">BoardMapper.java</h6>
<pre class="prettyprint">package net.java_school.mybatis;

import java.util.HashMap;
import java.util.List;

import net.java_school.board.Article;
import net.java_school.board.AttachFile;
import net.java_school.board.Comment;

public interface BoardMapper {

  public List&lt;Article&gt; selectListOfArticles(HashMap&lt;String, String&gt; hashmap);  

  public int selectCountOfArticles(HashMap&lt;String, String&gt; hashmap);

  public int insert(<strong>Article article</strong>);   

  <strong>public void insertAttachFile(AttachFile attachFile);</strong>

  public void update(<strong>Article article</strong>);  

  public void delete(int articleNo);

  public void updateHitPlusOne(int articleNo);  

  public Article selectOne(int articleNo);

  public Article selectNextOne(<strong>HashMap&lt;String, String&gt; hashmap</strong>); 

  public Article selectPrevOne(<strong>HashMap&lt;String, String&gt; hashmap</strong>);

  public List&lt;AttachFile&gt; selectListOfAttachFiles(int articleNo);    

  public void deleteFile(int attachFileNo); 

  public String selectOneBoard(String boardCd);

  public void insertComment(Comment comment);   

  public void updateComment(Comment comment);

  public void deleteComment(int commentNo);

  public List&lt;Comment&gt; selectListOfComments(int articleNo);

  public AttachFile selectOneAttachFile(int attachFileNo);

  public Comment selectOneComment(int commentNo);

} 
</pre>

<p>
Modify BoardService.java to be an interface.
</p>

<h6 class="src">BoardService.java</h6>
<pre class="prettyprint">package net.java_school.board;

import java.util.List;

public interface BoardService {

  public <strong>List&lt;Article&gt;</strong> getArticleList(String boardCd, String searchWord, <strong>Integer startRecord, Integer endRecord</strong>);

  public int getTotalRecord(String boardCd, String searchWord);

  public int addArticle(<strong>Article article</strong>);

  <strong>public void addAttachFile(AttachFile attachFile);</strong>

  public void modifyArticle(<strong>Article article</strong>);

  public void removeArticle(int articleNo);

  public void increaseHit(int articleNo);

  public Article getArticle(int articleNo);

  public Article getNextArticle(int articleNo, String boardCd, String searchWord);

  public Article getPrevArticle(int articleNo, String boardCd, String searchWord);

  public <strong>List&lt;AttachFile&gt;</strong> getAttachFileList(int articleNo);

  public void removeAttachFile(int attachFileNo);

  public Board getBoard(String boardCd);

  public void addComment(Comment comment);

  public void modifyComment(Comment comment);

  public void removeComment(int commentNo);

  public <strong>List&lt;Comment&gt;</strong> getCommentList(int articleNo);

  public AttachFile getAttachFile(int attachFileNo);

  public Comment getComment(int commentNo);

}
</pre>

<p>
In the net.java_school.board package, create BoardServiceImpl.java, which is an implementation of the BoardService interface.
</p>

<h6 class="src">BoardServiceImpl.java</h6>
<pre class="prettyprint">package net.java_school.board;

import java.util.HashMap;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import net.java_school.mybatis.BoardMapper;

@Service
public class BoardServiceImpl implements BoardService {
  @Autowired
  private BoardMapper boardMapper;

  @Override
  public <strong>List&lt;Article&gt;</strong> getArticleList(String boardCd, String searchWord, <strong>Integer startRecord, Integer endRecord</strong>) {
    HashMap&lt;String, String&gt; hashmap = new HashMap&lt;String, String&gt;();
    hashmap.put("boardCd", boardCd);
    hashmap.put("searchWord", searchWord);
    hashmap.put("start", startRecord.toString());
    hashmap.put("end", endRecord.toString());

    return boardMapper.selectListOfArticles(hashmap);
  }
    
  @Override 
  public int getTotalRecord(String boardCd, String searchWord) {
    HashMap&lt;String,String&gt; hashmap = new HashMap&lt;String,String&gt;();
    hashmap.put("boardCd", boardCd);
    hashmap.put("searchWord", searchWord);
    
    return boardMapper.selectCountOfArticles(hashmap);
  }
    
  @Override
  public int addArticle(Article article) {
    return boardMapper.insert(article);
  }

  @Override
  public void addAttachFile(AttachFile attachFile) {
    boardMapper.insertAttachFile(attachFile);
  }

  @Override
  public void modifyArticle(Article article) {
    boardMapper.update(article);
  }

  @Override
  public void removeArticle(int articleNo) {
    boardMapper.delete(articleNo);
  }

  @Override
  public void increaseHit(int articleNo) {
    boardMapper.updateHitPlusOne(articleNo);
  }

  @Override
  public Article getArticle(int articleNo) {
    return boardMapper.selectOne(articleNo);
  }

  @Override
  public Article getNextArticle(int articleNo, String boardCd, String searchWord) {
    HashMap&lt;String, String&gt; hashmap = new HashMap&lt;String, String&gt;();
    Integer no = articleNo;
    hashmap.put("articleNo", no.toString());
    hashmap.put("boardCd", boardCd);
    hashmap.put("searchWord", searchWord);

    return boardMapper.selectNextOne(hashmap);
  }

  @Override
  public Article getPrevArticle(int articleNo, String boardCd, String searchWord) {
    HashMap&lt;String, String&gt; hashmap = new HashMap&lt;String, String&gt;();
    Integer no = articleNo;
    hashmap.put("articleNo", no.toString());
    hashmap.put("boardCd", boardCd);
    hashmap.put("searchWord", searchWord);

    return boardMapper.selectPrevOne(hashmap);
  }

  @Override
  public <strong>List&lt;AttachFile&gt;</strong> getAttachFileList(int articleNo) {
    return boardMapper.selectListOfAttachFiles(articleNo);
  }

  @Override
  public void removeAttachFile(int attachFileNo) {
    boardMapper.deleteFile(attachFileNo);
  }

  @Override
  public Board getBoard(String boardCd) {
    return boardMapper.selectOneBoard(boardCd);
  }

  @Override
  public void addComment(Comment comment) {
    boardMapper.insertComment(comment);
  }

  @Override
  public void modifyComment(Comment comment) {
    boardMapper.updateComment(comment);
  }

  @Override
  public void removeComment(int commentNo) {
    boardMapper.deleteComment(commentNo);
  }

  @Override
  public <strong>List&lt;Comment&gt;</strong> getCommentList(int articleNo) {
    return boardMapper.selectListOfComments(articleNo);
  }

  @Override
  public AttachFile getAttachFile(int attachFileNo) {
    return boardMapper.selectOneAttachFile(attachFileNo);
  }

  @Override
  public Comment getComment(int commentNo) {
    return boardMapper.selectOneComment(commentNo);
  }

}
</pre>

<p>
Create NumbersForPaging.java that save numbers needed for paging as shown below.
</p>

<h6 class="src">NumbersForPaging.java</h6>
<pre class="prettyprint">
package net.java_school.commons;

public class NumbersForPaging {
	private int totalPage;
	private int firstPage;
	private int lastPage;
	private int prevBlock;
	private int nextBlock;
	private int listItemNo;
	
	public int getTotalPage() {
		return totalPage;
	}
	public void setTotalPage(int totalPage) {
		this.totalPage = totalPage;
	}
	public int getFirstPage() {
		return firstPage;
	}
	public void setFirstPage(int firstPage) {
		this.firstPage = firstPage;
	}
	public int getLastPage() {
		return lastPage;
	}
	public void setLastPage(int lastPage) {
		this.lastPage = lastPage;
	}
	public int getPrevBlock() {
		return prevBlock;
	}
	public void setPrevBlock(int prevBlock) {
		this.prevBlock = prevBlock;
	}
	public int getNextBlock() {
		return nextBlock;
	}
	public void setNextBlock(int nextBlock) {
		this.nextBlock = nextBlock;
	}
	public int getListItemNo() {
		return listItemNo;
	}
	public void setListItemNo(int listItemNo) {
		this.listItemNo = listItemNo;
	}
	
}
</pre>

<p>
Create Paginator.java that returns a NumberForPaging object as shown below.
</p>

<h6 class="src">Paginator.java</h6>
<pre class="prettyprint">
package net.java_school.commons;

public class Paginator {

	public NumbersForPaging getNumbersForPaging(int totalRecord, int page, int numPerPage, int pagePerBlock) {
		int totalPage = totalRecord / numPerPage;
		if (totalRecord % numPerPage != 0) totalPage++;
		int totalBlock = totalPage / pagePerBlock;
		if (totalPage % pagePerBlock != 0) totalBlock++;
		int block = page / pagePerBlock;
		if (page % pagePerBlock != 0) block++;
		int firstPage = (block - 1) * pagePerBlock + 1;
		int lastPage = block * pagePerBlock;
		int prevPage = 0;
		if (block &gt; 1) {
			prevPage = firstPage - 1;
		}
		int nextPage = 0;
		if (block &lt; totalBlock) {
			nextPage = lastPage + 1;
		}
		if (block &gt;= totalBlock) {
			lastPage = totalPage;
		}
		int listItemNo = totalRecord - (page - 1) * numPerPage;
		
		NumbersForPaging numbers = new NumbersForPaging();
		
		numbers.setTotalPage(totalPage);
		numbers.setFirstPage(firstPage);
		numbers.setLastPage(lastPage);
		numbers.setPrevBlock(prevPage);
		numbers.setNextBlock(nextPage);
		numbers.setListItemNo(listItemNo);
		
		return numbers;
	}

}
</pre>

<p>
Create the BbsController.java class in the net.java_school.controller package.
</p>

<h6 class="src">BbsController.java</h6>
<pre class="prettyprint">
package net.java_school.controller;

import java.io.File;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.Map;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import net.java_school.board.Article;
import net.java_school.board.AttachFile;
import net.java_school.board.BoardService;
import net.java_school.board.Comment;
import net.java_school.commons.WebContants;
import net.java_school.exception.AuthenticationException;
import net.java_school.user.User;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;

@Controller
@RequestMapping("/bbs")
public class BbsController <strong>extends Paginator</strong> {

	@Autowired
	private BoardService boardService;

	@RequestMapping(value="/list", method=RequestMethod.GET)
	public String list(String boardCd, 
			Integer page, 
			String searchWord,
			HttpServletRequest req,
			HttpSession session,
			Model model) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);
		if (user == null) {
			String url = req.getServletPath();
			String query = req.getQueryString();
			if (query != null) url += "?" + query;
			url = URLEncoder.encode(url, "UTF-8");
			return "redirect:/users/login?url=" + url;
		}

		int numPerPage = 10;
		int pagePerBlock = 10;

		int totalRecord = boardService.getTotalRecord(boardCd, searchWord);

		NumbersForPaging numbers = this.getNumbersForPaging(totalRecord, page, numPerPage, pagePerBlock);
		//oracle
		Integer startRecord = (page - 1) * numPerPage + 1;
		Integer endRecord = page * numPerPage;

		HashMap&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();
		map.put("boardCd", boardCd);
		map.put("searchWord", searchWord);
		map.put("start", startRecord.toString());
		map.put("end", endRecord.toString());
		List&lt;Article&gt; list = boardService.getArticleList(map);
		String boardName = boardService.getBoard(boardCd).getBoardNm_ko();
		
		Integer listItemNo = numbers.getListItemNo();
		Integer prevPage = numbers.getPrevBlock();
		Integer nextPage = numbers.getNextBlock();
		Integer firstPage = numbers.getFirstPage();
		Integer lastPage = numbers.getLastPage();

		model.addAttribute("list", list);
		model.addAttribute("boardName", boardName);
		model.addAttribute("listItemNo", listItemNo);
		model.addAttribute("prevPage", prevPage);
		model.addAttribute("nextPage", nextPage);
		model.addAttribute("firstPage", firstPage);
		model.addAttribute("lastPage", lastPage);

		return "bbs/list";

	}

	@RequestMapping(value="/write", method=RequestMethod.GET)
	public String writeForm(String boardCd,
			HttpServletRequest req,
			HttpSession session,
			Model model) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);
		if (user == null) {
			String url = req.getServletPath();
			String query = req.getQueryString();
			if (query != null) url += "?" + query;
			url = URLEncoder.encode(url, "UTF-8");
			return "redirect:/users/login?url=" + url;
		}

		String boardName = boardService.getBoard(boardCd).getBoardNm_ko();
		model.addAttribute("boardName", boardName);

		return "bbs/write";
	}

	@RequestMapping(value="/write", method=RequestMethod.POST)
	public String write(MultipartHttpServletRequest mpRequest,
			HttpSession session) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);
		if (user == null) {
			throw new AuthenticationException(WebContants.NOT_LOGIN);
		}

		String boardCd = mpRequest.getParameter("boardCd");
		String title = mpRequest.getParameter("title");
		String content = mpRequest.getParameter("content");

		Article article = new Article();
		article.setBoardCd(boardCd);
		article.setTitle(title);
		article.setContent(content);
		article.setEmail(user.getEmail());

		boardService.addArticle(article);

		Iterator&lt;String&gt; it = mpRequest.getFileNames();
		List&lt;MultipartFile&gt; fileList = new ArrayList&lt;MultipartFile&gt;();
		while (it.hasNext()) {
			MultipartFile multiFile = mpRequest.getFile((String) it.next());
			if (multiFile.getSize() &gt; 0) {
				String filename = multiFile.getOriginalFilename();
				multiFile.transferTo(new File(WebContants.UPLOAD_PATH + filename));
				fileList.add(multiFile);
			}
		}

		int size = fileList.size();
		for (int i = 0; i &lt; size; i++) {
			MultipartFile mpFile = fileList.get(i);
			AttachFile attachFile = new AttachFile();
			String filename = mpFile.getOriginalFilename();
			attachFile.setFilename(filename);
			attachFile.setFiletype(mpFile.getContentType());
			attachFile.setFilesize(mpFile.getSize());
			attachFile.setArticleNo(article.getArticleNo());
			attachFile.setEmail(user.getEmail());
			boardService.addAttachFile(attachFile);
		}

		return "redirect:/bbs/list?page=1&amp;boardCd=" + article.getBoardCd();
	}

	@RequestMapping(value="/view", method=RequestMethod.GET)
	public String view(Integer articleNo, 
			String boardCd, 
			Integer page,
			String searchWord,
			HttpServletRequest req,
			HttpSession session,
			Model model) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);
		if (user == null) {
			String url = req.getServletPath();
			String query = req.getQueryString();
			if (query != null) url += "?" + query;
			url = URLEncoder.encode(url, "UTF-8");
			return "redirect:/users/login?url=" + url;
		}

		boardService.increaseHit(articleNo);

		Article article = boardService.getArticle(articleNo);
		List&lt;AttachFile&gt; attachFileList = boardService.getAttachFileList(articleNo);
		Article nextArticle = boardService.getNextArticle(articleNo, boardCd, searchWord);
		Article prevArticle = boardService.getPrevArticle(articleNo, boardCd, searchWord);
		List&lt;Comment&gt; commentList = boardService.getCommentList(articleNo);

		String title = article.getTitle();
		String content = article.getContent();
		content = content.replaceAll(WebContants.LINE_SEPARATOR, "&lt;br /&gt;");
		int hit = article.getHit();
		String name = article.getName();
		String email = article.getEmail();
		String regdate = article.<strong>getRegdateForView()</strong>;

		model.addAttribute("title", title);
		model.addAttribute("content", content);
		model.addAttribute("hit", hit);
		model.addAttribute("name", name);
		model.addAttribute("email", email);
		model.addAttribute("regdate", regdate);
		model.addAttribute("attachFileList", attachFileList);
		model.addAttribute("nextArticle", nextArticle);
		model.addAttribute("prevArticle", prevArticle);
		model.addAttribute("commentList", commentList);

		int numPerPage = 10;
		int pagePerBlock = 10;

		int totalRecord = boardService.getTotalRecord(boardCd, searchWord);

		NumbersForPaging numbers = this.getNumbersForPaging(totalRecord, page, numPerPage, pagePerBlock);

		Integer startRecord = (page - 1) * numPerPage + 1;
		Integer endRecord = page * numPerPage;

		HashMap&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();
		map.put("boardCd", boardCd);
		map.put("searchWord", searchWord);
		map.put("start", startRecord.toString());
		map.put("end", endRecord.toString());
		List&lt;Article&gt; list = boardService.getArticleList(map);
		String boardName = boardService.getBoard(boardCd).getBoardNm_ko();
		
		int listItemNo = numbers.getListItemNo();
		int prevPage = numbers.getPrevBlock();
		int nextPage = numbers.getNextBlock();
		int firstPage = numbers.getFirstPage();
		int lastPage = numbers.getLastPage();

		model.addAttribute("list", list);
		model.addAttribute("listItemNo", listItemNo);
		model.addAttribute("prevPage", prevPage);
		model.addAttribute("firstPage", firstPage);
		model.addAttribute("lastPage", lastPage);
		model.addAttribute("nextPage", nextPage);
		model.addAttribute("boardName", boardName);

		return "bbs/view";
	}

	@RequestMapping(value="/addComment", method=RequestMethod.POST)
	public String addComment(Integer articleNo, 
			String boardCd, 
			Integer page, 
			String searchWord,
			String memo,
			HttpSession session) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);
		if (user == null) {
			throw new AuthenticationException(WebContants.NOT_LOGIN);
		}

		Comment comment = new Comment();
		comment.setArticleNo(articleNo);
		comment.setEmail(user.getEmail());
		comment.setMemo(memo);

		boardService.addComment(comment);

		searchWord = URLEncoder.encode(searchWord,"UTF-8");

		return "redirect:/bbs/view?articleNo=" + articleNo + 
				"&amp;boardCd=" + boardCd + 
				"&amp;page=" + page + 
				"&amp;searchWord=" + searchWord;

	}

	@RequestMapping(value="/updateComment", method=RequestMethod.POST)
	public String updateComment(Integer commentNo, 
			Integer articleNo, 
			String boardCd, 
			Integer page, 
			String searchWord, 
			String memo,
			HttpSession session) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);

		Comment comment = boardService.getComment(commentNo);

		if (user == null || !user.getEmail().equals(comment.getEmail())) {
			throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
		}

		comment.setMemo(memo);
		boardService.modifyComment(comment);

		searchWord = URLEncoder.encode(searchWord, "UTF-8");

		return "redirect:/bbs/view?articleNo=" + articleNo + 
				"&amp;boardCd=" + boardCd + 
				"&amp;page=" + page + 
				"&amp;searchWord=" + searchWord;

	}

	@RequestMapping(value="/deleteComment", method=RequestMethod.POST)
	public String deleteComment(Integer commentNo, 
			Integer articleNo, 
			String boardCd, 
			Integer page, 
			String searchWord,
			HttpSession session) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);

		Comment comment = boardService.getComment(commentNo);

		if (user == null || !user.getEmail().equals(comment.getEmail())) {
			throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
		}

		boardService.removeComment(commentNo);

		searchWord = URLEncoder.encode(searchWord,"UTF-8");

		return "redirect:/bbs/view?articleNo=" + articleNo + 
				"&amp;boardCd=" + boardCd + 
				"&amp;page=" + page + 
				"&amp;searchWord=" + searchWord;

	}

	@RequestMapping(value="/modify", method=RequestMethod.GET)
	public String modifyForm(Integer articleNo, 
			String boardCd,
			HttpSession session,
			Model model) {

		User user = (User) session.getAttribute(WebContants.USER_KEY);

		Article article = boardService.getArticle(articleNo);

		if (user == null || !user.getEmail().equals(article.getEmail())) {
			throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
		}

		String title = article.getTitle();
		String content = article.getContent();
		String boardName = boardService.getBoard(boardCd).getBoardNm_ko();

		model.addAttribute("title", title);
		model.addAttribute("content", content);
		model.addAttribute("boardName", boardName);

		return "bbs/modify";
	}

	@RequestMapping(value="/modify", method=RequestMethod.POST)
	public String modify(MultipartHttpServletRequest mpRequest,
			HttpSession session) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);

		int articleNo = Integer.parseInt(mpRequest.getParameter("articleNo"));
		Article article = boardService.getArticle(articleNo);

		if (!article.getEmail().equals(user.getEmail())) {
			throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
		}

		String boardCd = mpRequest.getParameter("boardCd");
		int page = Integer.parseInt(mpRequest.getParameter("page"));
		String searchWord = mpRequest.getParameter("searchWord");

		String title = mpRequest.getParameter("title");
		String content = mpRequest.getParameter("content");

		article.setTitle(title);
		article.setContent(content);
		article.setBoardCd(boardCd);
		boardService.modifyArticle(article);

		Iterator&lt;String&gt; it = mpRequest.getFileNames();
		List&lt;MultipartFile&gt; fileList = new ArrayList&lt;MultipartFile&gt;();
		while (it.hasNext()) {
			MultipartFile multiFile = mpRequest.getFile((String) it.next());
			if (multiFile.getSize() &gt; 0) {
				String filename = multiFile.getOriginalFilename();
				multiFile.transferTo(new File(WebContants.UPLOAD_PATH + filename));
				fileList.add(multiFile);
			}
		}

		int size = fileList.size();
		for (int i = 0; i &lt; size; i++) {
			MultipartFile mpFile = fileList.get(i);
			AttachFile attachFile = new AttachFile();
			String filename = mpFile.getOriginalFilename();
			attachFile.setFilename(filename);
			attachFile.setFiletype(mpFile.getContentType());
			attachFile.setFilesize(mpFile.getSize());
			attachFile.setArticleNo(articleNo);
			attachFile.setEmail(user.getEmail());
			boardService.addAttachFile(attachFile);
		}

		searchWord = URLEncoder.encode(searchWord,"UTF-8");
		return "redirect:/bbs/view?articleNo=" + articleNo 
				+ "&amp;boardCd=" + boardCd 
				+ "&amp;page=" + page 
				+ "&amp;searchWord=" + searchWord;

	}

	@RequestMapping(value="/download", method=RequestMethod.POST)
	public String download(String filename, HttpSession session, Model model) {
		User user = (User) session.getAttribute(WebContants.USER_KEY);
		if (user == null) {
			throw new AuthenticationException(WebContants.NOT_LOGIN);
		}

		model.addAttribute("filename", filename);
		return "inc/download";

	}

	@RequestMapping(value="/deleteAttachFile", method=RequestMethod.POST)
	public String deleteAttachFile(Integer attachFileNo, 
			Integer articleNo, 
			String boardCd, 
			Integer page, 
			String searchWord,
			HttpSession session) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);
		AttachFile attachFile = boardService.getAttachFile(attachFileNo);

		if (user == null || !user.getEmail().equals(attachFile.getEmail())) {
			throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
		}

		boardService.removeAttachFile(attachFileNo);

		searchWord = URLEncoder.encode(searchWord,"UTF-8");

		return "redirect:/bbs/view?articleNo=" + articleNo + 
				"&amp;boardCd=" + boardCd + 
				"&amp;page=" + page + 
				"&amp;searchWord=" + searchWord;

	}

	@RequestMapping(value="/del", method=RequestMethod.POST)
	public String del(Integer articleNo, 
			String boardCd, 
			Integer page, 
			String searchWord,
			HttpSession session) throws Exception {

		User user = (User) session.getAttribute(WebContants.USER_KEY);
		Article article = boardService.getArticle(articleNo);

		if (user == null || !user.getEmail().equals(article.getEmail())) {
			throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
		}

		boardService.removeArticle(articleNo);

		searchWord = URLEncoder.encode(searchWord, "UTF-8");

		return "redirect:/bbs/list?boardCd=" + boardCd + 
				"&amp;page=" + page + 
				"&amp;searchWord=" + searchWord;

	}

}
</pre>

<p>
The handler method parameters boardCd, page, and searchWord are assigned the values of the request parameters.<br />
If the request parameter name is curPage and the parameter name is page, resolve as follows.
</p>

<pre class="prettyprint">@RequestParam("curPage") String page</pre>

<p>
The writeForm() method is a handler for the /bbs/write request of the GET method.
</p>

<pre class="prettyprint">
@RequestMapping(value="write", method=RequestMethod.GET)
public String writeForm(String boardCd,HttpServletRequest req,HttpSession session...)
</pre>

<p>
The write() method handles the /bbs/write request of the POST method.
</p>

<pre class="prettyprint">
@RequestMapping(value="write", method=RequestMethod.POST)
public String write(MultipartHttpServletRequest mpRequest, HttpSession session) throws Exception
</pre>

<p>
The mpRequest parameter of the MultipartHttpServletRequest type has access to the files passed to the system.
</p>

<p>
The write () method first checks the login.<br />
If the user is not logged in, AuthenticationException exception occurs and the view resolver selects /WEB-INF/views/error.jsp as the view.
</p>

<pre class="prettyprint">
User user = (User) session.getAttribute(WebContants.USER_KEY);
if (user == null) {
    throw new AuthenticationException(WebContants.NOT_LOGIN);
}
</pre>

<p>
If a login check is passed, a new entry is inserted into the table.<br />
When boardService.addArticle (<strong>article</strong>) is executed, the <strong>article</strong>'s setArticleNo () is called to set the article's unique number.
</p>

<pre class="prettyprint">
String boardCd = mpRequest.getParameter("boardCd");
String title = mpRequest.getParameter("title");
String content = mpRequest.getParameter("content");

Article article = new Article();
article.setBoardCd(boardCd);
article.setTitle(title);
article.setContent(content);
article.setEmail(user.getEmail());

<strong>boardService.addArticle(article);</strong>
</pre>

<p>
After inserting the new post information into the table, move the uploaded file to the specified directory.<br />
The writing form page can only upload an attachment, but the handler method is implemented to handle multiple upload files.
</p>

<pre class="prettyprint">
Iterator&lt;String&gt; it = mpRequest.getFileNames();
List&lt;MultipartFile&gt; fileList = new ArrayList&lt;MultipartFile&gt;();
while (it.hasNext()) {
    MultipartFile multiFile = mpRequest.getFile((String) it.next());
    if (multiFile.getSize() &gt; 0) {
        String filename = multiFile.getOriginalFilename();
        multiFile.transferTo(new File(WebContants.UPLOAD_PATH + filename));
        fileList.add(multiFile);
    }
}
</pre>

<p>
The above code shows how to handle uploaded files.<br />
The MultipartHttpServletRequest type has access to the files passed to the system.
</p>

<p>
Spring MVC supports Apache's commons-fileupload for file uploads.<br />
The developer has to add the necessary dependencies and set the multipartResolver bean in the Spring configuration file.
</p>

<pre class="prettyprint">
&lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;commons-io&lt;/groupId&gt;
  &lt;artifactId&gt;commons-io&lt;/artifactId&gt;
  &lt;version&gt;2.5&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;
  &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;
  &lt;version&gt;1.3.2&lt;/version&gt;
&lt;/dependency&gt;
</pre>

<pre class="prettyprint">
&lt;bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver"&gt;
  &lt;property name="maxUploadSize" value="2097152" /&gt;
&lt;/bean&gt;
</pre>

<p>
The method moves the attachment to the upload directory and inserts the file information into the table.<br />
article.getArticleNo () gets the unique number of the article that is inserted into the table.
</p>

<pre class="prettyprint">
int size = fileList.size();
for (int i = 0; i &lt; size; i++) {
    MultipartFile mpFile = fileList.get(i);
    AttachFile attachFile = new AttachFile();
    String filename = mpFile.getOriginalFilename();
    attachFile.setFilename(filename);
    attachFile.setFiletype(mpFile.getContentType());
    attachFile.setFilesize(mpFile.getSize());
    attachFile.setArticleNo(<strong>article.getArticleNo()</strong>);
    attachFile.setEmail(user.getEmail());
    boardService.addAttachFile(attachFile);
}
</pre>

<p>
Two new methods are used: addArticle(article) and addAttachFile(attachFile).<br />
(Note that in the Model 2 board, the addArticle(article, attachFile) method is used)
</p>

<p>
When using a redirect, you need to add the boardCd and page=1 to the request as shown below.
</p>

<pre class="prettyprint">
return redirect:/bbs/list?page=1&amp;boardCd=" + article.getBoardCd();
</pre>


<h3>Detailed view</h3>

<p>
The following method is a handler for /bbs/view request.
</p>

<pre class="prettyprint">
@RequestMapping(value="/view", method=RequestMethod.GET)
public String view(Integer articleNo, 
        String boardCd, 
        Integer page,
        String searchWord,
        HttpServletRequest req,
        HttpSession session,
        Model model) throws Exception {
</pre>

<p>
The method first checks the login.<br />
If the login check is passed, the number of views is increased and the necessary data is produced on the detailed view screen.
</p>

<pre class="prettyprint">
boardService.increaseHit(articleNo);

Article article = boardService.getArticle(articleNo);
List&lt;AttachFile&gt; attachFileList = boardService.getAttachFileList(articleNo);
Article nextArticle = boardService.getNextArticle(articleNo, boardCd, searchWord);
Article prevArticle = boardService.getPrevArticle(articleNo, boardCd, searchWord);
List&lt;Comment&gt; commentList = boardService.getCommentList(articleNo);
String boardName = boardService.getBoard(boardCd).getBoardNm_ko();

String title = article.getTitle();
String content = article.getContent();
content = content.replaceAll(WebContants.LINE_SEPARATOR, "&lt;br /&gt;");
int hit = article.getHit();
String name = article.getName();
String email = article.getEmail();
String regdate = article.getRegdateForView();

model.addAttribute("title", title);
model.addAttribute("content", content);
model.addAttribute("hit", hit);
model.addAttribute("name", name);
model.addAttribute("email", email);
model.addAttribute("regdate", regdate);
model.addAttribute("attachFileList", attachFileList);
model.addAttribute("nextArticle", nextArticle);
model.addAttribute("prevArticle", prevArticle);
model.addAttribute("commentList", commentList);
</pre>

<h3>Add comment</h3>

<p>
The addComment() is a handler for /bbs/addComment request of POST method.
</p>

<pre class="prettyprint">
@RequestMapping(value="/addComment", method=RequestMethod.POST)
public String addComment(Integer articleNo, 
        String boardCd, 
        Integer page, 
        String searchWord,
        String memo,
        HttpSession session) throws Exception {
</pre>

<p>
That method first check login.
</p>

<pre class="prettyprint">
User user = (User) session.getAttribute(WebContants.USER_KEY);
if (user == null) {
    throw new AuthenticationException(WebContants.NOT_LOGIN);
}
</pre>

<p>
If login check passes, Comment information be inserted to the table with request parameters.
</p>

<pre class="prettyprint">
Comment comment = new Comment();
comment.setArticleNo(articleNo);
comment.setEmail(user.getEmail());
comment.setMemo(memo);

boardService.addComment(comment);
</pre>

<p>
The search term be encoded.
</p>

<pre class="prettyprint">
searchWord = URLEncoder.encode(searchWord,"UTF-8");
</pre>

<p>
The method gets your web browser to redirect the request to view.jsp.
</p>

<pre class="prettyprint">
return "redirect:/bbs/view?articleNo=" + articleNo + 
    "&amp;boardCd=" + boardCd + 
    "&amp;page=" + page + 
    "&amp;searchWord=" + searchWord;
</pre>

<h3>Modify comment</h3>

<p>
The updateComment() method is a handler for "/bbs/updateComment" request of POST method.
</p>

<pre class="prettyprint">
@RequestMapping(value="/updateComment", method=RequestMethod.POST)
public String updateComment(
        Integer commentNo, 
        Integer articleNo, 
        String boardCd, 
        Integer page, 
        String searchWord, 
        String memo,
        HttpSession session) throws Exception {
</pre>

<p>
This method first checks whether the user is logged in and the owner of the text, and throws a custom authentication exception if it does not pass the check.
</p>

<pre class="prettyprint">
User user = (User) session.getAttribute(WebContants.USER_KEY);

Comment comment = boardService.getComment(commentNo);

if (user == null || !user.getEmail().equals(comment.getEmail())) {
    throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
}
</pre>

<p>
If passed, this method modifies the comment with the request parameters.<br />
Only the content of the comment can be edited, and the original owner of the comment will not change, even if the administrator modifies the comment.
</p>

<pre class="prettyprint">
comment.setMemo(memo);
boardService.modifyComment(comment);
</pre>

<p>
The method gets your web browser to redirect the request to view.jsp.
</p>

<pre class="prettyprint">
searchWord = URLEncoder.encode(searchWord, "UTF-8");

return "redirect:/bbs/view?articleNo=" + articleNo + 
    "&amp;boardCd=" + boardCd + 
    "&amp;page=" + page + 
    "&amp;searchWord=" + searchWord;
</pre>

<p>
The deleteComment() is a handler for '/bbs/deleteComment' request of POST method.
</p>

<pre class="prettyprint">
@RequestMapping(value="/deleteComment", method=RequestMethod.POST)
public String deleteComment(
        Integer commentNo, 
        Integer articleNo, 
        String boardCd, 
        Integer page, 
        String searchWord,
        HttpSession session) throws Exception {
</pre>

<p>
This method first checks whether the user is logged in and the owner of the text, and throws a custom authentication exception if it does not pass the check.
</p>

<pre class="prettyprint">
User user = (User) session.getAttribute(WebContants.USER_KEY);

Comment comment = boardService.getComment(commentNo);

if (user == null || !user.getEmail().equals(comment.getEmail())) {
    throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
}
</pre>

<p>
If passed, this method deletes the comment with the request parameter.
</p>

<pre class="prettyprint">
boardService.removeComment(commentNo);
</pre>

<p>
The mehtod gets your web browser to redirect the request to view.jsp.
</p>

<pre class="prettyprint">
searchWord = URLEncoder.encode(searchWord,"UTF-8");

return "redirect:/bbs/view?articleNo=" + articleNo + 
    "&amp;boardCd=" + boardCd + 
    "&amp;page=" + page + 
    "&amp;searchWord=" + searchWord;
</pre>

<p>
The download() is a handle for '/bbs/download' request of POST method.
</p>

<pre class="prettyprint">
@RequestMapping(value="/download", method=RequestMethod.POST)
public String download(String filename, HttpSession session, Model model) {
</pre>

<p>
The method passes the filename to download.jsp.
</p>

<pre class="prettyprint">
model.addAttribute("filename", filename);
return "inc/download";
</pre>

<h3>Modify view.jsp</h3>

<p>
Add the following javascript code to the view.jsp.
</p>

<pre class="prettyprint">
function download(filename) {
    var form = document.getElementById("downForm");
    form.filename.value = filename;
    form.submit();
}
</pre>

<p>
Add the following form to the #form-group.
</p>

<pre class="prettyprint">
&lt;form id="downForm" action="download" method="post"&gt;
    &lt;input type="hidden" name="filename" /&gt;
&lt;/form&gt;
</pre>

<p>
Modify file download links as shown below.
</p>

<pre class="prettyprint">
&lt;a href="javascript:download('${file.filename }')"&gt;${file.filename }&lt;/a&gt;
</pre>


<h2>Test</h2>

<pre class="commandLine">mvn clean compile war:inplace</pre>

<p>
Modify ROOT.xml as shown below.
</p>

<h6 class="src">ROOT.xml</h6>
<pre class="prettyprint">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Context
    docBase="C:/www/spring-bbs/<strong>src/main/webapp</strong>"
    reloadable="true"&gt;
&lt;/Context&gt;
</pre>

<p>
Restart Tomcat.<br />
Visit http://localhost:8080/bbs/list?boarCd=smalltalk&amp;page=1.
</p>

<h2>Authentication Summary</h2>

<p>
The following is the authentication code used in the method of the bulletin board controller.
</p>

<pre class="prettyprint">
User user = (User) session.getAttribute(WebContants.USER_KEY);
if (user == null) {
  String url = req.getServletPath();
  String query = req.getQueryString();
  if (query != null) url += "?" + query;
  url = URLEncoder.encode(url, "UTF-8");
  return "redirect:/users/login?url=" + url;
}
</pre>

<pre class="prettyprint">
User user = (User) session.getAttribute(WebContants.USER_KEY);
if (user == null) {
  throw new AuthenticationException(WebContants.NOT_LOGIN);
}
</pre>

<pre class="prettyprint">
if (user == null || !user.getEmail().equals(comment.getEmail())) {
  throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
}
</pre>

<p>
The following is the authentication code used in the method of the UsersController.
</p>

<pre class="prettyprint">
User user = userService.login(email, passwd);
if (user == null) {
  return "redirect:/users/login?url=" + url + "&amp;msg=Login-Failed";
} else {
  session.setAttribute(WebContants.USER_KEY, user);
  if (url != null &amp;&amp; !url.equals("")) {
  return "redirect:" + url;
}

return "redirect:/";
</pre>

<pre class="prettyprint">
User user = (User) session.getAttribute(WebContants.USER_KEY);
if (user == null) {
  String url = req.getServletPath();
  String query = req.getQueryString();
  if (query != null) url += "?" + query;
  url = URLEncoder.encode(url, "UTF-8");
  return "redirect/users/login?url=" + url;
}
</pre>

<pre class="prettyprint">
User loginUser = (User) session.getAttribute(WebContants.USER_KEY);

if (loginUser == null) {
  throw new AuthenticationException(WebContants.NOT_LOGIN);
}

if (userService.login(loginUser.getEmail(), user.getPasswd()) == null) {
  throw new AuthenticationException(WebContants.AUTHENTICATION_FAILED);
}
</pre>

<pre class="prettyprint">
String email = ((User)session.getAttribute(WebContants.USER_KEY)).getEmail();
</pre>

<p>
The following is the authentication code used in JSPs.
</p>

<pre class="prettyprint">
&lt;!-- omit --&gt;

&lt;p id="file-list" style="text-align: right"&gt;
  &lt;c:forEach var="file" items="${attachFileList }" varStatus="status"&gt;    
  &lt;a href="javascript:download('${file.filename }')"&gt;${file.filename }&lt;/a&gt;
  <strong>&lt;c:if test="${user.email == file.email }"&gt;</strong>
  &lt;a href="javascript:deleteAttachFile('${file.attachFileNo }')"&gt;x&lt;/a&gt;
  <strong>&lt;/c:if&gt;</strong>
  &lt;br /&gt;
  &lt;/c:forEach&gt;
&lt;/p&gt;

&lt;!-- omit --&gt;

<strong>&lt;c:if test="${user.email == comment.email }"&gt;</strong>    
&lt;span class="modify-del"&gt;
  &lt;a href="javascript:modifyCommentToggle('${comment.commentNo }')"&gt;Modify&lt;/a&gt;
  | &lt;a href="javascript:deleteComment('${comment.commentNo }')"&gt;Del&lt;/a&gt;
&lt;/span&gt;
<strong>&lt;/c:if&gt;</strong>  

&lt;!-- omit --&gt;

<strong>&lt;c:if test="${user.email == email }"&gt;</strong>
&lt;div class="fl"&gt;
  &lt;input type="button" value="Modify" onclick="goModify()" /&gt;
  &lt;input type="button" value="Del" onclick="goDelete()"/&gt;
&lt;/div&gt;
<strong>&lt;/c:if&gt;</strong>
</pre>

<p>
The next section covers Spring Security.<br />
Spring Security is an authentication framework.<br />
</p>

<p>
If an error occurs during testing, you need to check the log file set in log4j.xml or the log file in CATALINA_HOME/logs.<br />
No one will understand all of the log messages.<br />
You should develop your ability to see the log and infer the cause of the error.
</p>

<span id="refer">References</span>
<ul id="references">
	<li><a href="http://www.mybatis.org/mybatis-3/logging.html">http://www.mybatis.org/mybatis-3/logging.html</a></li>
</ul>
</article>